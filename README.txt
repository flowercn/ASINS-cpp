======================================================================
  STM32 并行I2C传感器数据压缩固件 - 逻辑说明 (Firmware Logic Readme)
======================================================================

### 1. 系统概述 (System Overview)

本固件设计用于一个特殊的硬件系统，该系统通过一个主控MCU，以并行方式同时与64个ICM20602惯性测量单元（IMU）进行I2C通信。

固件的核心目标是以精确的200Hz频率，稳定地采集所有64个传感器的数据，经过压缩处理后，通过DMA乒乓缓冲机制，将处理后的数据包经由串口发送出去。

### 2. 核心设计思想：读取与打包分离

为了在复杂的处理逻辑下依然保持高速、无丢帧的数据采集，固件采用了“读取”和“打包”两个阶段分离的核心思想。

- **读取阶段**: 优先保证I2C通信的效率，快速、连续地将所有需要的原始数据从64个传感器中读出，存入MCU的内存（RAM）。
- **打包阶段**: 在获取到全部原始数据后，再对内存中的数据进行复杂的重组、压缩和打包，准备好最终要通过DMA发送的数据帧。


### 3. 数据处理详细步骤

#### 步骤 3.1: 高效批量读取 (Efficient Bulk Read)

此阶段的目标是尽快将传感器中的12个关键寄存器（6个加速度计 + 6个陀螺仪）的值全部读出。

1.  程序会执行 **12次** 独立的I2C读操作。
2.  每一次操作都会读取一个特定的寄存器（例如 `ACCEL_XOUT_L`）。
3.  得益于并行的硬件设计，每一次I2C读操作都会同时返回**64个字节**，分别对应64个传感器的该寄存器值。
4.  这12次操作的结果（总计 `12 * 64` 字节）被完整地存放在一个临时的二维数组 `raw_data[12][64]` 中，供下一阶段使用。

#### 步骤 3.2: 智能数据打包 (Intelligent Data Packing)

此阶段的目标是将 `12 * 64` 字节的原始数据，压缩并打包成 **8个** `SerialImuPacket_t` 结构体（每个67字节），以便通过DMA发送。

**数据包 1-7 (主数据包):**

这7个数据包用于传递最关键的传感器数据。它们的 `ucData[64]` 字段是这样被填充的：

- **包 1**: `memcpy` 拷贝 `raw_data` 中对应 `ACCEL_XOUT_L` 的64个字节。
- **包 2**: `memcpy` 拷贝 `raw_data` 中对应 `ACCEL_YOUT_L` 的64个字节。
- **包 3**: `memcpy` 拷贝 `raw_data` 中对应 `ACCEL_ZOUT_H` 的64个字节。
- **包 4**: `memcpy` 拷贝 `raw_data` 中对应 `ACCEL_ZOUT_L` 的64个字节。
- **包 5**: `memcpy` 拷贝 `raw_data` 中对应 `GYRO_XOUT_L` 的64个字节。
- **包 6**: `memcpy` 拷贝 `raw_data` 中对应 `GYRO_YOUT_L` 的64个字节。
- **包 7**: `memcpy` 拷贝 `raw_data` 中对应 `GYRO_ZOUT_L` 的64个字节。

**数据包 8 (元数据包):**

这个包是数据压缩的核心。它不再包含任何一个寄存器的原始值，而是存放了被丢弃的5个高位寄存器（`AX_H`, `AY_H`, `GX_H`, `GY_H`, `GZ_H`）的**符号信息**和**数据有效性**。

其 `ucData[64]` 数组的布局见文末的通信协议详情。

### 4. 公共信息与发送

最后，所有8个数据包的公共字段（`ucHead`, `ucSerialNumber`）会被统一填充，然后整个数据块（`8 * 67 = 536` 字节）被提交给DMA进行发送。

---

### 5. 通信协议 (v2.0)

#### 5.1 标准数据包结构 (包 1-7)

每个标准数据包大小为 **67 字节**。

| 字段 (Field)       | 长度 (Bytes) | 值 (Value)            | 说明 (Description) |
| :----------------- | :----------- | :-------------------- | :--- |
| `ucHead[2]`        | 2            | `0xA5`, `0x5A`        | 同步帧头 |
| `ucSerialNumber`   | 1            | `0x01` - `0x07`       | 包序号 |
| `ucData[64]`       | 64           | `(见步骤3.2)`         | 传感器寄存器的原始值 |

#### 5.2 元数据包结构 (包 8)

元数据包大小同样为 **67 字节**，其 `ucData` 字段有特殊布局。

| 字段 (Field)       | 长度 (Bytes) | 值 (Value)            | 说明 (Description) |
| :----------------- | :----------- | :-------------------- | :--- |
| `ucHead[2]`        | 2            | `0xA5`, `0x5A`        | 同步帧头 |
| `ucSerialNumber`   | 1            | `0x08`                | 包序号 |
| `ucData[64]`       | 64           | `(见下表)`            | 压缩后的元数据 |

**元数据包 `ucData[64]` 字段详解:**

| `ucData` 索引 | 长度 (Bytes) | 内容 (Content)          | 说明 (Description) |
| :------------ | :----------- | :---------------------- | :--- |
| `[0-7]`       | 8            | **AX_H 符号位图**       | 64个传感器的 `ACCEL_XOUT_H` 符号 (`0xFF`->`1`, `0x00`->`0`) |
| `[8-15]`      | 8            | **AY_H 符号位图**       | 64个传感器的 `ACCEL_YOUT_H` 符号 |
| `[16-23]`     | 8            | **GX_H 符号位图**       | 64个传感器的 `GYRO_XOUT_H` 符号 |
| `[24-31]`     | 8            | **GY_H 符号位图**       | 64个传感器的 `GYRO_YOUT_H` 符号 |
| `[32-39]`     | 8            | **GZ_H 符号位图**       | 64个传感器的 `GYRO_ZOUT_H` 符号 |
| `[40-47]`     | 8            | **错误标志位图**        | 记录高位字节非 `0x00`/`0xFF` 的异常情况 |
| `[48]`        | 1            | **CRC-8 校验和**        | 对包1-7的 `ucData` 字段 (总计 7*64=448字节) 计算出的CRC-8值 |
| `[49-63]`     | 15           | **预留 (Reserved)**     | 当前未使用，全部为0 |


